#!/bin/bash
# lirt-setup-hooks: Install lirt hooks in workspaces
# Usage: lirt-setup-hooks [--check] [workspace...]

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIRT_ROOT="$(dirname "$SCRIPT_DIR")"

# Hook configuration as JSON
HOOKS_JSON='{
  "hooks": {
    "PreCompact": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "command",
            "command": "echo \"\\n⚠️  BEFORE COMPACTION - Chronicle Review:\\n\\n1. Chronicle-worthy? (new capability, decision, insight, pattern, Go/GraphQL lessons?)\\n   → If yes: Create chronicle bead IMMEDIATELY (bd create --type chronicle ...)\\n\\n2. See roles/chronicler.md for the detection protocol and rich description template.\\n\\nDo NOT proceed until you have reviewed ALL session work for chronicle-worthy items.\\n\""
          }
        ]
      }
    ],
    "PreToolUse": [
      {
        "matcher": "Bash(*push*)",
        "hooks": [
          {
            "type": "command",
            "command": "echo \"\\n⚠️  PRE-PUSH CHRONICLE GATE\\n\\nReview ALL commits being pushed:\\n\\n□ Chronicle-worthy? (new capability, decision, insight, Go patterns, GraphQL design?)\\n  → If yes: Create chronicle bead BEFORE pushing (bd create --type chronicle ...)\\n\\n□ Open chronicle beads? Run: bd ready --type chronicle\\n  → If not empty: Process with lirt-chronicler BEFORE pushing\\n\\nSTOP and create beads before pushing if anything was missed.\\n\""
          }
        ]
      }
    ]
  }
}'

# Default workspaces to configure
DEFAULT_WORKSPACES=(
    "$LIRT_ROOT"
)

CHECK_ONLY=false
WORKSPACES=()

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        --check)
            CHECK_ONLY=true
            shift
            ;;
        --help|-h)
            echo "Usage: lirt-setup-hooks [--check] [workspace...]"
            echo ""
            echo "Install lirt hooks in Claude Code workspaces."
            echo ""
            echo "Options:"
            echo "  --check    Only check if hooks are installed (don't modify)"
            echo ""
            echo "Arguments:"
            echo "  workspace  Specific workspace paths to configure"
            echo "             Default: lirt root"
            echo ""
            echo "Hooks installed:"
            echo "  PreCompact  - Reminder to review for chronicle-worthy items"
            echo "  PreToolUse  - Reminder before git push to complete checklist"
            exit 0
            ;;
        *)
            WORKSPACES+=("$1")
            shift
            ;;
    esac
done

# Use default workspaces if none specified
if [[ ${#WORKSPACES[@]} -eq 0 ]]; then
    WORKSPACES=("${DEFAULT_WORKSPACES[@]}")
fi

# Check if jq is available
if ! command -v jq &> /dev/null; then
    echo "Error: jq is required but not installed" >&2
    exit 1
fi

# Install or check hooks in a workspace
install_hooks() {
    local workspace="$1"
    local settings_dir="$workspace/.claude"
    local settings_file="$settings_dir/settings.json"

    # Check if workspace exists
    if [[ ! -d "$workspace" ]]; then
        if [[ "$CHECK_ONLY" == "true" ]]; then
            echo "⚠️  $workspace: directory does not exist"
            return 1
        else
            echo "Creating workspace: $workspace"
            mkdir -p "$workspace"
        fi
    fi

    # Check mode
    if [[ "$CHECK_ONLY" == "true" ]]; then
        if [[ ! -f "$settings_file" ]]; then
            echo "❌ $workspace: no settings.json"
            return 1
        fi

        # Check for hooks
        local has_precompact has_pretooluse
        has_precompact=$(jq -e '.hooks.PreCompact | length > 0' "$settings_file" 2>/dev/null || echo "false")
        has_pretooluse=$(jq -e '.hooks.PreToolUse | length > 0' "$settings_file" 2>/dev/null || echo "false")

        if [[ "$has_precompact" == "true" && "$has_pretooluse" == "true" ]]; then
            echo "✓  $workspace: hooks installed"
            return 0
        else
            echo "❌ $workspace: hooks missing (PreCompact: $has_precompact, PreToolUse: $has_pretooluse)"
            return 1
        fi
    fi

    # Install mode
    mkdir -p "$settings_dir"

    if [[ -f "$settings_file" ]]; then
        # Merge hooks into existing settings
        local existing
        existing=$(cat "$settings_file")

        # Merge hooks (new hooks take precedence)
        local merged
        merged=$(echo "$existing" | jq --argjson hooks "$HOOKS_JSON" '
            .hooks = ($hooks.hooks * (.hooks // {}))
        ')

        echo "$merged" > "$settings_file"
        echo "✓  $workspace: hooks updated"
    else
        # Create new settings file
        echo "$HOOKS_JSON" > "$settings_file"
        echo "✓  $workspace: hooks installed"
    fi
}

# Process all workspaces
exit_code=0
for workspace in "${WORKSPACES[@]}"; do
    if ! install_hooks "$workspace"; then
        exit_code=1
    fi
done

if [[ "$CHECK_ONLY" == "true" ]]; then
    if [[ $exit_code -eq 0 ]]; then
        echo ""
        echo "All hooks are properly configured."
    else
        echo ""
        echo "Some hooks are missing. Run 'lirt-setup-hooks' to install."
    fi
fi

exit $exit_code
