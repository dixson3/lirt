#!/bin/bash
# lirt-town-id: Resolve, set, or initialize town ID
# Usage: lirt-town-id [get|set <id>|init]

set -euo pipefail

# Resolve town root (parent of first .git found)
resolve_town_root() {
    local dir="${GT_ROOT:-$(pwd)}"
    while [[ "$dir" != "/" ]]; do
        if [[ -d "$dir/.git" ]]; then
            echo "$dir"
            return 0
        fi
        dir="$(dirname "$dir")"
    done
    echo "Error: Not in a git repository" >&2
    return 1
}

# Resolve town ID using priority chain
resolve_town_id() {
    local town_root="$1"
    local lirt_config="$town_root/.lirt"

    # 1. Explicit config (persisted)
    if [[ -f "$lirt_config/town-id" ]]; then
        cat "$lirt_config/town-id"
        return 0
    fi

    # 2. mayor/town.json name field
    if [[ -f "$town_root/mayor/town.json" ]]; then
        local name
        name=$(jq -r '.name // empty' "$town_root/mayor/town.json" 2>/dev/null)
        if [[ -n "$name" ]]; then
            echo "$name"
            return 0
        fi
    fi

    # 3. Git remote basename (strip gastown- prefix)
    local remote_url
    remote_url=$(git -C "$town_root" remote get-url origin 2>/dev/null || true)
    if [[ -n "$remote_url" ]]; then
        local basename
        basename=$(echo "$remote_url" | xargs basename 2>/dev/null | sed 's/\.git$//' | sed 's/^gastown-//')
        if [[ -n "$basename" ]]; then
            echo "$basename"
            return 0
        fi
    fi

    # 4. Directory name + hostname fallback
    echo "$(basename "$town_root")-$(hostname -s)"
}

# Get the persisted town ID (if any)
get_persisted_id() {
    local town_root="$1"
    local id_file="$town_root/.lirt/town-id"
    if [[ -f "$id_file" ]]; then
        cat "$id_file"
    fi
}

# Set the town ID (persist it)
set_town_id() {
    local town_root="$1"
    local new_id="$2"
    local lirt_config="$town_root/.lirt"

    mkdir -p "$lirt_config"
    echo "$new_id" > "$lirt_config/town-id"
    echo "Town ID set to: $new_id"
}

# Initialize town ID (resolve and persist if not already set)
init_town_id() {
    local town_root="$1"
    local lirt_config="$town_root/.lirt"
    local id_file="$lirt_config/town-id"

    # Check if already persisted
    if [[ -f "$id_file" ]]; then
        local persisted
        persisted=$(cat "$id_file")
        local detected
        # Temporarily remove the file to get detected value
        mv "$id_file" "$id_file.tmp"
        detected=$(resolve_town_id "$town_root")
        mv "$id_file.tmp" "$id_file"

        if [[ "$persisted" != "$detected" ]]; then
            echo "Warning: Persisted town-id '$persisted' differs from detected '$detected'" >&2
            echo "         Use 'lirt-town-id set <id>' to change if needed" >&2
        fi
        echo "$persisted"
        return 0
    fi

    # Resolve and persist
    local town_id
    town_id=$(resolve_town_id "$town_root")
    mkdir -p "$lirt_config"
    echo "$town_id" > "$id_file"
    echo "Initialized town ID: $town_id"
}

# Main
main() {
    local cmd="${1:-get}"
    local town_root
    town_root=$(resolve_town_root)

    case "$cmd" in
        get)
            resolve_town_id "$town_root"
            ;;
        set)
            if [[ -z "${2:-}" ]]; then
                echo "Usage: lirt-town-id set <id>" >&2
                exit 1
            fi
            set_town_id "$town_root" "$2"
            ;;
        init)
            init_town_id "$town_root"
            ;;
        --help|-h)
            echo "Usage: lirt-town-id [get|set <id>|init]"
            echo ""
            echo "Commands:"
            echo "  get   - Display current town ID (resolved or persisted)"
            echo "  set   - Set and persist town ID"
            echo "  init  - Initialize town ID (resolve and persist if not set)"
            echo ""
            echo "Resolution priority:"
            echo "  1. .lirt/town-id (persisted)"
            echo "  2. mayor/town.json name field"
            echo "  3. Git remote basename (strip gastown- prefix)"
            echo "  4. Directory name + hostname"
            ;;
        *)
            echo "Unknown command: $cmd" >&2
            echo "Usage: lirt-town-id [get|set <id>|init]" >&2
            exit 1
            ;;
    esac
}

main "$@"
