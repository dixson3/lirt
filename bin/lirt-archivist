#!/usr/bin/env bash
# lirt-archivist - Process archive beads into structured entries
#
# Invokes the archivist agent to batch-process open archive beads.
# See .claude/agents/archivist.md for the agent definition.
# See roles/archivist.md for the detection protocol.

set -euo pipefail

# Find project root (look for AGENTS.md or .git)
find_project_root() {
    local dir="$PWD"
    while [[ "$dir" != "/" ]]; do
        if [[ -f "$dir/AGENTS.md" ]] || [[ -d "$dir/.git" ]]; then
            echo "$dir"
            return 0
        fi
        dir="$(dirname "$dir")"
    done
    return 1
}

PROJECT_ROOT=$(find_project_root) || {
    echo "Error: Not in a lirt workspace"
    exit 1
}

cd "$PROJECT_ROOT"

# Check for open archive beads first
OPEN_BEADS=$(bd ready --type archive 2>/dev/null || true)

if [[ -z "$OPEN_BEADS" ]]; then
    echo "No open archive beads to process."
    exit 0
fi

echo "Found open archive beads:"
echo "$OPEN_BEADS"
echo ""
echo "Processing with archivist agent..."
echo ""

# Invoke the archivist agent
# The agent will:
# 1. Read all open archive beads
# 2. Create archive entries (decisions or research)
# 3. Update index files
# 4. Close processed beads
claude --agent archivist --print "Process all open archive beads into archive entries. Query with 'bd ready --type archive', create entries in {{answer.archive_path}}, update index files, and close processed beads with 'bd close <id>'."
