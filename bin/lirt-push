#!/usr/bin/env bash
# lirt-push - Push with chronicle bead check
#
# Ensures all chronicle beads are processed before pushing.
# Use instead of raw 'git push' in lirt workspaces.

set -euo pipefail

# Find lirt root (look for diary/)
find_lirt_root() {
    local dir="$PWD"
    while [[ "$dir" != "/" ]]; do
        if [[ -d "$dir/diary" && -f "$dir/AGENTS.md" ]]; then
            echo "$dir"
            return 0
        fi
        dir="$(dirname "$dir")"
    done
    return 1
}

LIRT_ROOT=$(find_lirt_root) || {
    echo "Error: Not in a lirt workspace (no diary/ found)"
    exit 1
}

cd "$LIRT_ROOT"

echo "üîç Pre-Push Chronicle Gate..."

# Check for open chronicle beads
OPEN_BEADS=$(bd ready --type chronicle 2>/dev/null | grep -c "^lirt-" || true)

if [[ "$OPEN_BEADS" -gt 0 ]]; then
    echo ""
    echo "‚ùå BLOCKED: $OPEN_BEADS open chronicle bead(s) found"
    echo ""
    echo "Open chronicle beads:"
    bd ready --type chronicle
    echo ""
    echo "Process beads before pushing:"
    echo "  1. Run: lirt-chronicler"
    echo "  2. Verify: bd ready --type chronicle  # Must return empty"
    echo "  3. Then run: lirt-push"
    echo ""
    exit 1
fi

echo "‚úì No open chronicle beads"
echo ""
echo "Review ALL commits being pushed for chronicle-worthy items:"
echo "  ‚Ä¢ Decision made with reasoning worth preserving?"
echo "  ‚Ä¢ Insight about Go CLI development or Linear API integration?"
echo "  ‚Ä¢ Pattern or lesson learned?"
echo "  ‚Ä¢ Course correction?"
echo ""
echo "If yes, create chronicle bead now:"
echo "  bd create --title 'Chronicle: [topic]' --type chronicle --priority 3 --add-label [category] --description '[rich context]'"
echo ""
read -p "Any chronicle-worthy work to capture? [y/N]: " -r response

case "${response,,}" in
    y|yes)
        echo ""
        echo "Please create chronicle bead first, then run 'lirt-push' again."
        exit 1
        ;;
    *)
        echo "‚úì No chronicle-worthy work - proceeding"
        ;;
esac

echo ""
echo "üì§ Pushing..."
exec git push "$@"
