#!/usr/bin/env bash
# lirt-push - Push with chronicle bead check
#
# Ensures all chronicle beads are processed before pushing.
# Use instead of raw 'git push' in lirt workspaces.

set -euo pipefail

# Find project root
find_project_root() {
    local dir="$PWD"
    while [[ "$dir" != "/" ]]; do
        if [[ -f "$dir/AGENTS.md" ]] || [[ -d "$dir/.git" ]]; then
            echo "$dir"
            return 0
        fi
        dir="$(dirname "$dir")"
    done
    return 1
}

PROJECT_ROOT=$(find_project_root) || {
    echo "Error: Not in a lirt workspace"
    exit 1
}

cd "$PROJECT_ROOT"

echo "Pre-Push Chronicle Gate..."

# Check for open chronicle beads (chronicle label on task-type issues)
# Filter to only lines starting with status markers (○, ●, ◐, etc.) to exclude tips/warnings
OPEN_BEADS=$(bd list --label chronicle --status open 2>/dev/null | grep -E "^[○●◐◑]" | head -20 || true)

if [[ -n "$OPEN_BEADS" ]]; then
    BEAD_COUNT=$(echo "$OPEN_BEADS" | wc -l | tr -d ' ')
    echo ""
    echo "BLOCKED: $BEAD_COUNT open chronicle bead(s) found"
    echo ""
    echo "Open chronicle beads:"
    echo "$OPEN_BEADS"
    echo ""
    echo "Process beads before pushing:"
    echo "  1. Run: lirt-chronicler"
    echo "  2. Verify: bd list --label chronicle --status open  # Must return empty"
    echo "  3. Then run: lirt-push"
    echo ""
    exit 1
fi

echo "No open chronicle beads"
echo ""

# Proceed with push
echo "Pushing..."
git push "$@"
