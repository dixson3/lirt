# Beads-Mediated Protocol System for Agent Coordination

**Date**: 2026-01-27 17:07 PST
**Context**: Implementing cross-cutting coordination for lirt agents
**Type**: decision + pattern

## Summary

We established a beads-mediated coordination pattern for cross-cutting concerns in lirt (and potentially all Gas Town projects). Instead of agents immediately invoking other agents when they detect work, they create rich bead descriptions (300-600 words) that go into a persistent queue. Execution agents process the queue asynchronously, enabling non-blocking workflows, intelligent batching, and context preservation across session boundaries.

This pattern now governs three lirt protocols: chronicle (capturing insights), test identification (detecting testable scenarios), and code quality reporting (finding issues during review).

## Alternatives Considered

### 1. Immediate Invocation Pattern (Previous Approach)

Agent detects chronicle-worthy moment → immediately invokes lirt-chronicler.

**Pros:**
- Simple, straightforward
- Diary entry created right away
- No queue to manage

**Cons:**
- Context might still be lost (agent provides summary, not full context)
- Blocks workflow (agent must stop work)
- Requires context switch (agent becomes invoker)
- No batching opportunity

### 2. Hybrid Approach

Major insights → immediate invocation
Minor insights → beads queue

**Pros:**
- Captures critical items immediately
- Defers less urgent work

**Cons:**
- Subjective boundary between major/minor
- Complexity in deciding when to defer
- Still has blocking problem for major items

### 3. Beads-Mediated Coordination (Chosen)

Agent detects → creates rich bead (300-600 words) → execution agent processes queue.

**Pros:**
- Non-blocking (agent continues work)
- Rich context captured while fresh
- Allows batching/grouping of related items
- Persistent queue survives session boundaries
- Clear separation of detection vs execution
- Reusable pattern across concerns

**Cons:**
- Diary entries not created immediately (delayed until bead processing)
- Requires discipline to create rich descriptions
- Extra step before push (process queue)

## Reasoning

The key insight: **Detection and execution are separate concerns.**

The detecting agent has full context about what just happened but shouldn't stop work to write diary entries, implement tests, or fix code quality issues. The executing agent can produce quality output (diary entries, tests, fixes) but needs rich input to work from.

Beads provide the bridge:

**Persistence**: Context captured in 300-600 word descriptions survives session boundaries and context compaction. The rich description is the source of truth.

**Non-blocking**: Detecting agent continues work immediately after creating bead. No context switch required.

**Batching**: Execution agent can intelligently group related beads. For chronicle: beads created within 4 hours with shared themes can be combined into a single coherent diary entry.

**Separation**: Clear roles defined in `roles/` (detection protocol) vs `.claude/agents/` (execution agent).

**Reusability**: The pattern extends beyond chronicle to test identification and code quality reporting. Any cross-cutting concern that spans multiple agents and sessions is a candidate.

The 300-600 word rich description requirement directly addresses the context loss risk. Without rich descriptions, the queue becomes a bottleneck where information is compressed too early. The structured template ensures essential elements are captured: type, context, alternatives considered, reasoning, trade-offs, implementation details, and implications.

## Implementation

### Protocol Definitions (Detection)

**`roles/chronicler.md`**: Detection protocol for chronicle-worthy moments
- ALL agents watch for: decisions, insights, patterns, corrections, lessons
- Create bead IMMEDIATELY when identified (while context fresh)
- Rich description template with 300-600 word minimum
- Category labels: decision, insight, pattern, correction, lesson
- Topic labels: go-idioms, graphql, cli-ux, performance, testing, security

**`roles/test-case-identifier.md`**: Detection protocol for testable scenarios
- ALL agents watch during specification, implementation, review
- Create task bead with `requires:testing` label
- 150-300 word minimum describing scenario, context, test cases needed

**`roles/code-quality-reporter.md`**: Detection protocol for code quality issues
- lirt-code-reviewer (read-only tools) creates bug beads
- Categories: idioms, performance, security, maintainability, testing
- 200-400 word minimum with issue, location, why it matters, suggested fix

### Execution Agents

**`.claude/agents/lirt-chronicler.md`**: Processes chronicle beads
- Query: `bd ready --type chronicle`
- Analyze for grouping (4-hour window, shared themes)
- Create diary entries from bead descriptions
- Update `diary/_index.md`
- Close processed beads: `bd close <id1> <id2> ...`

**`.claude/agents/lirt-test-engineer.md`**: Processes test beads
- Query: `bd ready --label requires:testing`
- Implement tests from bead descriptions
- Close bead when complete

**`.claude/agents/lirt-code-reviewer.md`**: Creates quality beads
- Read-only review agent
- Cannot fix issues directly
- Creates beads for lirt-specialist to address

### Infrastructure

**`.beads/config.yaml`**: Custom type configuration
```yaml
types:
  custom:
    - chronicle
```

Enables: `bd create --type chronicle`

**`bin/lirt-push`**: Pre-Push Chronicle Gate
- Checks: `bd ready --type chronicle` must return empty
- Blocks push if chronicle beads are open
- Prompts to capture any new chronicle-worthy items before push

**`AGENTS.md`**: Comprehensive protocol documentation
- Detection patterns for all three protocols
- Bead creation templates
- Processing workflows
- Landing the Plane requirements

### Commits

- **95997be**: Implement beads-mediated protocol system for lirt
  - 9 files changed, 1942 insertions, 283 deletions
  - Created protocol definitions, updated agent instructions

- **b9b9ea9**: Add beads custom type configuration
  - Added `.beads/config.yaml` with chronicle type

## Implications

### For lirt Development

ALL lirt agents now follow the Detection → Beads → Execution pattern for three cross-cutting concerns:

1. **Chronicle**: Decisions, insights, patterns, corrections, lessons
2. **Test identification**: Testable scenarios discovered during work
3. **Code quality**: Issues found during review

The Pre-Push Chronicle Gate enforces queue discipline: `bd ready --type chronicle` must return empty before pushing. This prevents chronicle debt from accumulating.

### Pattern Reusability

This pattern is NOT lirt-specific. It applies to any scenario where:
- Work spans multiple agents
- Work persists across sessions
- Detection and execution are separate concerns
- Batching/grouping is beneficial
- Non-blocking workflow matters

Candidates in other Gas Town projects:
- clio: Similar chronicle protocol could capture CLI development insights
- Future tools: Any project with specialized agents

### Gas Town Standard

This could become a Gas Town standard coordination mechanism:

**When to use beads-mediated coordination:**
- Cross-cutting concerns (multiple agents involved)
- Persistent work (survives sessions, compaction)
- Asynchronous execution (non-blocking)
- Batch processing opportunities

**When NOT to use:**
- Immediate results required
- Single agent, synchronous task
- No persistence needed

### Critical Success Factor: Rich Descriptions

The entire pattern depends on rich descriptions (300-600 words for chronicle). Without them, context loss negates all benefits. The structured template is non-negotiable:
- Type (decision/insight/pattern/correction/lesson)
- Context (what was happening)
- Alternatives considered (for decisions)
- Reasoning (why this choice)
- Trade-offs (what was gained/lost)
- Implementation (file:line references, commits)
- Implications (what this means for future)

Skimping on description quality breaks the pattern.

### Town-Level Documentation Needed

This pattern should be documented in Gas Town infrastructure (`/Users/james/gt/plugins/` or similar) as a reusable coordination mechanism. The documentation should include:
- Pattern description
- When to use it
- How to adapt it for different projects
- Custom bead type setup
- Pre-push gate enforcement
- Example protocols

## Related Beads

- lirt-3n8: Chronicle: Beads-mediated protocol system for agent coordination
